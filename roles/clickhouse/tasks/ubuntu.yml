- name: Install required packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - gnupg
    state: present
    update_cache: yes

- name: Add ClickHouse GPG key
  shell: curl -fsSL 'https://packages.clickhouse.com/rpm/lts/repodata/repomd.xml.key' | gpg --dearmor -o /usr/share/keyrings/clickhouse-keyring.gpg

- name: Add ClickHouse repository
  shell: echo "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg] https://packages.clickhouse.com/deb stable main" > /etc/apt/sources.list.d/clickhouse.list

- name: Update package cache
  apt:
    update_cache: yes

- name: Install ClickHouse server and client
  apt:
    name:
      - clickhouse-server
      - clickhouse-client
    state: present

- name: Start and enable ClickHouse service
  systemd:
    name: clickhouse-server
    state: started
    enabled: yes